<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'" http-equiv=Content-Security-Policy><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://reichtumqian.pages.dev name=base><title>
Reichtum's Blog • MAE 测试环境搭建</title><link title="Reichtum's Blog - Atom Feed" href=https://reichtumqian.pages.dev/atom.xml rel=alternate type=application/atom+xml><link href="https://reichtumqian.pages.dev/custom_subset.css?h=0b9535a28bc3d5bf2321" rel=stylesheet><link href="https://reichtumqian.pages.dev/main.css?h=28b3fcbb58f2f22a8c44" rel=stylesheet><meta content="light dark" name=color-scheme><meta content="Reichtum's Blog" name=description><meta content="Reichtum's Blog" property=og:description><meta content="MAE 测试环境搭建" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale><meta content=https://reichtumqian.pages.dev/blog/blog-mae-ce-shi-huan-jing-da-jian/ property=og:url><meta content="Reichtum's Blog" property=og:site_name><noscript><link href=https://reichtumqian.pages.dev/no_js.css rel=stylesheet></noscript><script src=https://reichtumqian.pages.dev/js/initializeTheme.min.js></script><script defer src=https://reichtumqian.pages.dev/js/themeSwitcher.min.js></script><script src="https://reichtumqian.pages.dev/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><script defer src=https://reichtumqian.pages.dev/js/lunr/lunrStemmerSupport.min.js></script><script defer src=https://reichtumqian.pages.dev/js/lunr/lunr.zh.min.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://reichtumqian.pages.dev/>Reichtum's Blog</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://reichtumqian.pages.dev/blog/>blog </a><li><a class="nav-links no-hover-padding" href=https://reichtumqian.pages.dev/archive/>archive </a><li><a class="nav-links no-hover-padding" href=https://reichtumqian.pages.dev/tags/>tags </a><li><a class="nav-links no-hover-padding" href=https://reichtumqian.pages.dev/projects/>projects </a><li class=menu-icons-container><ul class=menu-icons-group><li class="js menu-icon"><div aria-label="Press $SHORTCUT to open search" class="search-icon interactive-icon" title="Press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></ul></ul></div></nav></header><div class=content><main><article class=h-entry><h1 class="p-name article-title">MAE 测试环境搭建</h1><a class="u-url u-uid" href=https://reichtumqian.pages.dev/blog/blog-mae-ce-shi-huan-jing-da-jian/></a><ul class=meta><span class="hidden p-author h-card"> <a class=u-url href=https://reichtumqian.pages.dev rel=author title=Reichtum>Reichtum</a> </span><li><time class=dt-published datetime=2025-07-29>29th Jul 2025</time><li title="539 words"><span aria-hidden=true class=separator>•</span>3 min read<li class=tag><span aria-hidden=true class=separator>•</span>Tags: <li class=tag><a class=p-category href=https://reichtumqian.pages.dev/tags/machine-learning/>Machine Learning</a>, <li class=tag><a class=p-category href=https://reichtumqian.pages.dev/tags/mae/>MAE</a>, <li class=tag><a class=p-category href=https://reichtumqian.pages.dev/tags/computer-vision/>Computer Vision</a></ul><section class="e-content body"><h2 id=bei-jing>背景</h2><p>近期想将我们设计的优化器在 MAE + ViTs 预训练上进行测试，原本想用 <code>Hugging Face</code>​ 的 <code>transformers</code>​ 自带的 <code>run_mae.py</code>​ （见 <a href=https://github.com/huggingface/transformers/tree/main/examples/pytorch/image-pretraining>transformers/examples/pytorch/image-pretraining</a>）进行测试，结果测试出来发现表现不是太好（不知道是不是我哪里搞错了）。比如在 CIFAR-10 上进行预训练，几个 Epoch （对应 200 个 global step） 后 train loss 就不下降了。<p><img alt=train-loss-mae-vit-cifar10-epoch50 src=https://reichtumqian.pages.dev/blog/blog-mae-ce-shi-huan-jing-da-jian/assets/train-loss-mae-vit-cifar10-epoch50-20250730091452-ntqwezp.png>​<p>而 Facebook 的官方 <code>mae</code>​ 不带训练日志，而且环境有点儿过于古老了，装起来容易遇到各种 Bug。最后找到了 <a href=https://github.com/pengzhiliang/MAE-pytorch>pengzhiliang/MAE-pytorch</a> 感觉可以用来测试一下，包含完整的训练日志。<h2 id=zhun-bei-shu-ju-ji-imagenet-1k>准备数据集（ImageNet-1k）</h2><p>我从 Hugging Face 官网下载了 ImageNet 数据集（见 <a href=https://huggingface.co/datasets/ILSVRC/imagenet-1k>ILSVRC/imagenet-1k · Datasets at Hugging Face</a> ），国内下载速度不行的话可以尝试使用 <code>hf-mirror</code>​ 站点。下载完成内容如下：<pre class=z-code><code><span class="z-text z-plain">test_images.tar.gz  train_images_0.tar.gz  train_images_1.tar.gz  train_images_2.tar.gz  train_images_3.tar.gz  train_images_4.tar.gz  val_images.tar.gz
</span></code></pre><blockquote><p>如果使用 hugging face 的 <code>datasets</code>​ 库加载数据集则不需要自己手动处理 <code>tar.gz</code>​ 文件</blockquote><p>训练集压缩包中的图片名称类似于 <code>n02974003_1569_n02974003.JPEG</code>​，其中 <code>n02974003</code>​ 是 class label，<code>1569</code>​ 是 image ID。验证集中的图片名称类似于 <code>ILSVRC2012_val_00027905_n02107908.JPEG</code>​ 。一般的程序读取 ImageFolder 会需要将数据集组织为以下格式<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">imagenet_structured/</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">├──</span></span><span class="z-meta z-function-call z-arguments z-shell"> n01440764/</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── n01440764_10026.JPEG</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   └── ...</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">├──</span></span><span class="z-meta z-function-call z-arguments z-shell"> n02974003/</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   ├── n02974003_1569.JPEG</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">│</span></span><span class="z-meta z-function-call z-arguments z-shell">   └── ...</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└──</span></span><span class="z-meta z-function-call z-arguments z-shell"> ... (其他所有类别</span><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre><p>因此我们需要首先将数据集全部解压出来，然后写个脚本按类别分到不同子文件夹。<ul><li>将所有图片解压到临时文件夹</ul><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"> imagenet1k</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> imagenet1k/flat_train imagenet1k/flat_val</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 执行解压脚本</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-for z-shell">for</span><span class="z-meta z-group z-for z-shell"> f <span class="z-keyword z-control z-in z-shell">in</span> train_images_<span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>.tar.gz</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-loop z-do z-shell">do</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tar</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>xzvf</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">f</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>C</span> imagenet1k/flat<span class="z-constant z-character z-escape z-shell">\_</span>train/</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-end z-shell">done</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tar</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>xzvf</span> val<span class="z-constant z-character z-escape z-shell">\_</span>images.tar.gz<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>C</span> imagenet1k/flat<span class="z-constant z-character z-escape z-shell">\_</span>val/</span>
</span></code></pre><ul><li>运行脚本整理文件结构，首先 <code>mkdir processed\_data</code>​ 然后执行脚本</ul><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> --- 整理训练集 ---</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>开始整理训练集结构...<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 进入临时训练集文件夹</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> flat<span class="z-constant z-character z-escape z-shell">\_</span>train</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 遍历所有 .JPEG 文件，根据文件名创建目录并移动文件</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-for z-shell">for</span><span class="z-meta z-group z-for z-shell"> file <span class="z-keyword z-control z-in z-shell">in</span> <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>.JPEG</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-loop z-do z-shell">do</span>
</span><span class="z-source z-shell z-bash">  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 从文件名 'n02974003\_1569\_n02974003.JPEG' 中提取 'n02974003'</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash">  <span class="z-variable z-other z-readwrite z-assignment z-shell">class<span class="z-constant z-character z-escape z-shell">\_</span>name</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cut</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>\_<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f1</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span>
</span><span class="z-source z-shell z-bash">  
</span><span class="z-source z-shell z-bash">  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 在最终的目标目录 ../processed\_data/train/ 中创建类别子文件夹</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>../processed\_data/train/<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">class_name</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash">  
</span><span class="z-source z-shell z-bash">  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 将文件移动到新创建的目录中</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mv</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>../processed\_data/train/<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">class_name</span></span>/<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-end z-shell">done</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 返回主目录</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> ..</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>训练集整理完毕。<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> --- 整理验证集 ---</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>开始整理验证集结构...<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 进入临时验证集文件夹</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> flat_val</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-for z-shell">for</span><span class="z-meta z-group z-for z-shell"> file <span class="z-keyword z-control z-in z-shell">in</span> <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>.JPEG</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-keyword z-control z-loop z-do z-shell">do</span>
</span><span class="z-source z-shell z-bash">  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 从文件名末尾提取类别 (e.g., ILSVRC2012_val_..._n02107908.JPEG)</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash">  <span class="z-variable z-other z-readwrite z-assignment z-shell">class_name</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">awk</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>F</span><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>[_.]<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>{print $4}<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>../processed\_data/val/<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">class_name</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mv</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">file</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>../processed\_data/val/<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">class_name</span></span>/<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-loop z-end z-shell">done</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 返回主目录</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> ..</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>验证集整理完毕。<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span></code></pre><h2 id=yun-xing-ce-shi>运行测试</h2><ul><li>首先下载代码</ul><pre class=z-code><code><span class="z-text z-plain">git clone https://github.com/pengzhiliang/MAE-pytorch.git
</span></code></pre><ul><li>创建环境：由于 <code>requirements.txt</code>​ 中的包版本较老，使用新版 python 大概率装不了各种报错，我这里用 conda 创建一个 python=3.9 的环境，然后去 <a href=https://pytorch.org/get-started/previous-versions/>Previous PyTorch Versions</a> 查看对应的 CUDA 版本。我也提供了 <code>environment.yml</code>​ 可直接更新环境（我用的是 4090）：</ul><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">name:</span></span><span class="z-meta z-function-call z-arguments z-shell"> mae</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">channels:</span></span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> pytorch</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> nvidia</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> conda-forge</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> defaults</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dependencies:</span></span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> python=3.9</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> pytorch::pytorch=1.8.1</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> pytorch::torchvision</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> pytorch::pytorch-cuda=11.8</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> pip</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> pip:</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> timm==0.4.12</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> Pillow</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> blobfile</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> mypy</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> numpy<span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span><span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">2</span>.0</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> pytest</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> requests</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> einops</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> tensorboardX</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> scipy</span>
</span></code></pre><ul><li>新建一个 <code>run.sh</code>​ 辅助执行</ul><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Set the path to save checkpoints</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">OUTPUT_DIR</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>output/pretrain_mae_base_patch16_224<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> path to imagenet-1k train set</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">DATA_PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>/path/to/ImageNet_ILSVRC2012/train<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> batch_size can be adjusted according to the graphics card</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">OMP_NUM_THREADS</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">1</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">python</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> torch.distributed.launch<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>nproc_per_node</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span>8 run_mae_pretraining.py <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>data_path</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">DATA<span class="z-constant z-character z-escape z-shell">\_</span>PATH</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>mask<span class="z-constant z-character z-escape z-shell">\_</span>ratio</span> 0.75 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>model</span> pretrain<span class="z-constant z-character z-escape z-shell">\_</span>mae<span class="z-constant z-character z-escape z-shell">\_</span>base<span class="z-constant z-character z-escape z-shell">\_</span>patch16<span class="z-constant z-character z-escape z-shell">\_</span>224 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>batch<span class="z-constant z-character z-escape z-shell">\_</span>size</span> 128 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>opt</span> adamw <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>opt<span class="z-constant z-character z-escape z-shell">\_</span>betas</span> 0.9 0.95 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>warmup<span class="z-constant z-character z-escape z-shell">\_</span>epochs</span> 40 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>epochs</span> 1600 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">        --</span>output<span class="z-constant z-character z-escape z-shell">\_</span>dir</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">OUTPUT_DIR</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span></span>
</span></code></pre><ul><li>执行 <code>./run.sh</code>​ 成功运行程序</ul><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./run.sh                                                                                                                                                                                     (mae</span><span class="z-meta z-function-call z-shell"></span>) 
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">optimizer</span></span><span class="z-meta z-function-call z-arguments z-shell"> settings: <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>lr<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>: 7.5e-05<span class="z-punctuation z-separator z-shell">,</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>weight_decay<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>: 0.0<span class="z-punctuation z-separator z-shell">,</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>eps<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>: 1e-08<span class="z-punctuation z-separator z-shell">,</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>betas<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span>: <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0.9, 0.95<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span><span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Use</span></span><span class="z-meta z-function-call z-arguments z-shell"> step level LR</span> <span class="z-keyword z-operator z-logical z-job z-shell">&</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">WD</span></span><span class="z-meta z-function-call z-arguments z-shell"> scheduler!</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Set</span></span><span class="z-meta z-function-call z-arguments z-shell"> warmup steps = 122600</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Set</span></span><span class="z-meta z-function-call z-arguments z-shell"> warmup steps = 0</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Max</span></span><span class="z-meta z-function-call z-arguments z-shell"> WD = 0.0500000, Min WD = 0.0500000</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Auto</span></span><span class="z-meta z-function-call z-arguments z-shell"> resume checkpoint: </span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Start</span></span><span class="z-meta z-function-call z-arguments z-shell"> training for 1600 epochs</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[W</span></span><span class="z-meta z-function-call z-arguments z-shell"> reducer.cpp:1050] Warning: find_unused_parameters=True was specified in DDP constructor, but did not find any unused parameters. This flag results in an extra traversal of the autograd graph every iteration, which can adversely affect performance. If your model indeed never has any unused parameters, consider turning this flag off. Note that this warning may be a false positive your model has flow control causing later iterations to have unused parameters. (function operator(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>   0/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 3:59:19  lr: 0.000000  min_lr: 0.000000  loss: 1.6757 (1.6757</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4795 (2.4795</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 4.6849  data: 3.0511  max mem: 6911</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>  10/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 0:34:19  lr: 0.000000  min_lr: 0.000000  loss: 1.6727 (1.6722</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4795 (2.4770</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.6740  data: 0.3446  max mem: 8010</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>  20/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 0:23:12  lr: 0.000000  min_lr: 0.000000  loss: 1.6720 (1.6713</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4731 (2.4757</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.2458  data: 0.0447  max mem: 8010</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>  30/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 0:19:40  lr: 0.000000  min_lr: 0.000000  loss: 1.6711 (1.6712</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4731 (2.4737</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.2321  data: 0.0290  max mem: 8010</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>  40/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 0:17:55  lr: 0.000000  min_lr: 0.000000  loss: 1.6698 (1.6707</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4698 (2.4723</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.2486  data: 0.0466  max mem: 8010</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>  50/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 0:20:32  lr: 0.000000  min_lr: 0.000000  loss: 1.6684 (1.6703</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4694 (2.4712</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.4394  data: 0.2366  max mem: 8010</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>  60/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 0:21:06  lr: 0.000000  min_lr: 0.000000  loss: 1.6665 (1.6693</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4636 (2.4694</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.5570  data: 0.3525  max mem: 8010</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Epoch:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>0<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>  70/3065<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span>  eta: 0:21:11  lr: 0.000000  min_lr: 0.000000  loss: 1.6646 (1.6685</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">loss_scale:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 65536.0000 (65536.0000</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">weight_decay:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.0500 (0.0500</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grad_norm:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.4563 (2.4678</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">time:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.4655  data: 0.2640  max mem: 8010</span>
</span></code></pre><p>附上跑了 6 个 Epoch 的学习曲线<p><img alt=image src=https://reichtumqian.pages.dev/blog/blog-mae-ce-shi-huan-jing-da-jian/assets/image-20250730163459-w40dw7h.png>​<p>‍</section></article></main><div id=button-container><div id=toc-floating-container><input class=toggle id=toc-toggle type=checkbox><label class=overlay for=toc-toggle></label><label title="Toggle Table of Contents" class=button for=toc-toggle id=toc-button><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg></label><div class=toc-content><div class=toc-container><ul><li><a href=https://reichtumqian.pages.dev/blog/blog-mae-ce-shi-huan-jing-da-jian/#bei-jing>背景</a><li><a href=https://reichtumqian.pages.dev/blog/blog-mae-ce-shi-huan-jing-da-jian/#zhun-bei-shu-ju-ji-imagenet-1k>准备数据集（ImageNet-1k）</a><li><a href=https://reichtumqian.pages.dev/blog/blog-mae-ce-shi-huan-jing-da-jian/#yun-xing-ce-shi>运行测试</a></ul></div></div></div><a title="Go to the top of the page" class=no-hover-padding href=# id=top-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div><link href=https://reichtumqian.pages.dev/katex.min.css rel=stylesheet><script defer src=https://reichtumqian.pages.dev/js/katex.min.js></script><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://reichtumqian.pages.dev/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://reichtumqian.pages.dev/atom.xml> <img alt=feed loading=lazy src=https://reichtumqian.pages.dev/social_icons/rss.svg title=feed> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> Powered by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> </small></div></section><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search… role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> 1 result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>